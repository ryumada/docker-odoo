# --- CORS Origin Whitelist for Localhost ---
map $http_origin $cors_origin_header {
    # Default is empty (i.e., blocked)
    default "";

    # Allowed Localhost Domains (Replace PORT with your actual frontend port if different)
    ~^http:\/\/localhost(:[0-9]{2,5})?$ $http_origin;
    ~^http:\/\/127\.0\.0\.1(:[0-9]{2,5})?$ $http_origin;

    # Allow requests without an Origin header
    "" "";
}

# --- Main Server Block (Proxying to the Local Backend) ---
server {
    # This must be the port your Nginx is listening on for client requests.
    listen $NGINX_HTTP_PORT;
    server_name localhost;
    proxy_read_timeout 720s;
    proxy_connect_timeout 720s;
    proxy_send_timeout 720s;
    proxy_http_version 1.1;

    if ($host != "localhost") {
        return 403;
    }

    # CORS Check Logic
    set $check_origin "0";
    if ($http_origin ~* .) {
        set $check_origin "1";
    }

    if ($cors_origin_header = "") {
        set $check_origin "${check_origin}1";
    }

    if ($check_origin = "11") {
        return 403;
    }

    # Headers for proxy mode
    proxy_set_header Connection             '';
    proxy_set_header Host                   $host;
    proxy_set_header X-Forwarded-Host       $host;
    proxy_set_header X-Forwarded-For        $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto      $scheme;
    proxy_set_header X-Real-IP              $remote_addr;

    # Proxy logs
    access_log      /var/log/nginx/odoo.localhost.access.log;
    error_log       /var/log/nginx/odoo.localhost.error.log;

    location /web/login {
        proxy_redirect off;
        limit_except GET POST { deny all; }

        keepalive_timeout 60s;
        client_body_timeout 30s;
        client_max_body_size 2M;
        proxy_connect_timeout 30s;
        proxy_read_timeout 30s;
        proxy_send_timeout 30s;

        # Direct Proxy Pass to the main backend port
        proxy_pass http://127.0.0.1:$HTTP_PORT;
    }

    location ~ /web/database/.* {
        proxy_redirect off;
        limit_except GET POST {deny all; }

        keepalive_timeout 300s;
        client_body_timeout 300s;
        proxy_connect_timeout 240s;
        proxy_read_timeout 240s;
        proxy_send_timeout 240s;

        # Direct Proxy Pass to the main backend port
        proxy_pass http://127.0.0.1:$HTTP_PORT;
    }

    location /websocket {
        limit_except GET POST { deny all; }

        proxy_set_header Upgrade                $http_upgrade;
        proxy_set_header Connection             "upgrade";

        # Direct Proxy Pass to the websocket backend port
        proxy_pass http://127.0.0.1:$GEVENT_PORT;
    }

    location / {
        proxy_redirect off;
        limit_except GET POST { deny all; }

        # Direct Proxy Pass to the main backend port
        proxy_pass http://127.0.0.1:$HTTP_PORT;
    }

    location ~* /web/static/ {
        limit_except GET {deny all; }
        proxy_cache_valid 200 90m;
        proxy_buffering on;
        expires 864000;

        # Direct Proxy Pass to the main backend port
        proxy_pass http://127.0.0.1:$HTTP_PORT;
    }

    location /website/info {
        rewrite ^/web/database/.* /non-existent-page last;
    }
}
