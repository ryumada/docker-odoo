# Category: Config
# File: nginx_sites_available-localhost
# Description: Nginx server block configuration for Odoo (Localhost Proxy).
# Usage: Symlink to sites-enabled.
# Maintainer: ryumada

# --- Main Server Block (Proxying to the Local Backend) ---
server {
    # This must be the port your Nginx is listening on for client requests.
    listen 0.0.0.0:$NGINX_HTTP_PORT;
    server_name localhost;
    proxy_read_timeout 720s;
    proxy_connect_timeout 720s;
    proxy_send_timeout 720s;
    proxy_http_version 1.1;

    # Headers for proxy mode
    proxy_set_header Connection             '';
    proxy_set_header Host                   $http_host;
    proxy_set_header X-Forwarded-Host       $http_host;
    proxy_set_header X-Forwarded-For        $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto      $scheme;
    proxy_set_header X-Real-IP              $remote_addr;

    # Proxy logs
    access_log      /var/log/nginx/odoo.localhost.access.log;
    error_log       /var/log/nginx/odoo.localhost.error.log;

    location /web/login {
        proxy_redirect off;
        limit_except GET POST { deny all; }

        keepalive_timeout 60s;
        client_body_timeout 30s;
        client_max_body_size 2M;
        proxy_connect_timeout 30s;
        proxy_read_timeout 30s;
        proxy_send_timeout 30s;

        # Direct Proxy Pass to the main backend port
        proxy_pass http://127.0.0.1:$HTTP_PORT;
    }

    location ~ /web/database/.* {
        proxy_redirect off;
        limit_except GET POST {deny all; }

        keepalive_timeout 300s;
        client_body_timeout 300s;
        proxy_connect_timeout 240s;
        proxy_read_timeout 240s;
        proxy_send_timeout 240s;

        # Direct Proxy Pass to the main backend port
        proxy_pass http://127.0.0.1:$HTTP_PORT;
    }

    location /websocket {
        limit_except GET POST { deny all; }

        proxy_set_header Upgrade                $http_upgrade;
        proxy_set_header Connection             "upgrade";

        # Direct Proxy Pass to the websocket backend port
        proxy_pass http://127.0.0.1:$GEVENT_PORT;
    }

    location / {
        proxy_redirect off;
        limit_except GET POST { deny all; }

        # Direct Proxy Pass to the main backend port
        proxy_pass http://127.0.0.1:$HTTP_PORT;
    }

    location ~* /web/static/ {
        limit_except GET {deny all; }
        proxy_cache_valid 200 90m;
        proxy_buffering on;
        expires 864000;

        # Direct Proxy Pass to the main backend port
        proxy_pass http://127.0.0.1:$HTTP_PORT;
    }

    location /website/info {
        rewrite ^/web/database/.* /non-existent-page last;
    }
}
