#!/usr/bin/env bash
set -e
# Category: Utility
# Description: Backs up Odoo data via the web endpoint.
# Usage: ./scripts/backupdata.sh
# Dependencies: curl, sudo, git

# Detect Repository Owner to run non-root commands as that user
CURRENT_DIR=$(dirname "$(readlink -f "$0")")
CURRENT_DIR_USER=$(stat -c '%U' "$CURRENT_DIR")
PATH_TO_ODOO=$(sudo -u "$CURRENT_DIR_USER" git -C "$(dirname "$(readlink -f "$0")")" rev-parse --show-toplevel)
SERVICE_NAME=$(basename "$PATH_TO_ODOO")
REPOSITORY_OWNER=$(stat -c '%U' "$PATH_TO_ODOO")

# Configuration
ENV_FILE=".env"
UPDATE_SCRIPT="./scripts/update-env-file.sh"
MAX_BACKUPS=3

# --- Logging Functions & Colors ---
# Define colors for log messages
readonly COLOR_RESET="\033[0m"
readonly COLOR_INFO="\033[0;34m"
readonly COLOR_SUCCESS="\033[0;32m"
readonly COLOR_WARN="\033[1;33m"
readonly COLOR_ERROR="\033[0;31m"

# Function to log messages with a specific color and emoji
log() {
  local color="$1"
  local emoji="$2"
  local message="$3"
  echo -e "${color}[$(date +"%Y-%m-%d %H:%M:%S")] ${emoji} ${message}${COLOR_RESET}"
}

log_info() { log "${COLOR_INFO}" "ℹ️" "$1"; }
log_success() { log "${COLOR_SUCCESS}" "✅" "$1"; }
log_warn() { log "${COLOR_WARN}" "⚠️" "$1"; }
log_error() { log "${COLOR_ERROR}" "❌" "$1"; }
# ------------------------------------

error_handler() {
  local exit_code=$1
  local line_no=$2
  local command_name=$3
  log_error "An error occurred on line $line_no."
  log_error "Exit Code: $exit_code"
  log_error "Command: $command_name"
  log_error "Note: The specific error message should be printed in the lines above this error."
  exit "$exit_code"
}

trap 'error_handler $? $LINENO "$BASH_COMMAND"' ERR

# --- Centralized Cleanup Hook ---
cleanup_on_error() {
    local exit_code=$?
    if [ $exit_code -ne 0 ]; then
        # Only clean up the file if the script failed (so we don't delete successful backups)
        if [ -n "$BACKUP_FILE_PATH" ] && [ -f "$BACKUP_FILE_PATH" ]; then
            rm -f "$BACKUP_FILE_PATH"
        fi
    fi
}
trap cleanup_on_error EXIT

function checkOdooEndpoint() {
  log_info "Checking if Odoo endpoint is accessible on port $PORT..."
  if curl --output /dev/null --silent --head --fail "http://localhost:$PORT"; then
    log_success "Odoo endpoint is accessible."
  else
    log_warn "Odoo endpoint is NOT accessible at http://localhost:$PORT. Retrying with longer timeout..."
    if curl --output /dev/null --silent --head --fail --connect-timeout 10 "http://localhost:$PORT"; then
      log_success "Odoo endpoint is accessible."
    else
      log_error "Odoo endpoint is NOT accessible at http://localhost:$PORT. Please check if the service is running."
      exit 1
    fi
  fi
}

ODOO_DATABASE_NAME_PRD=$(grep "^DB_NAME=" "$PATH_TO_ODOO/.env" | cut -d "=" -f 2 | sed 's/^[[:space:]\n]*//g' | sed 's/[[:space:]\n]*$//g')
ADMIN_PASSWD=$(grep "^ADMIN_PASSWD=" "$PATH_TO_ODOO/.env" | cut -d "=" -f 2 | sed 's/^[[:space:]\n]*//g' | sed 's/[[:space:]\n]*$//g')
PORT=$(grep "^PORT=" "$PATH_TO_ODOO/.env" | cut -d "=" -f 2 | sed 's/^[[:space:]\n]*//g' | sed 's/[[:space:]\n]*$//g')
ZIP_FILE_NAME=backupdata-$SERVICE_NAME.zip
BACKUP_FILE_PATH="/tmp/$ZIP_FILE_NAME"

if ! command -v curl &> /dev/null; then
    log_error "curl command could not be found. Please install curl first."
    echo "For Ubuntu: sudo apt install curl"
    echo "For CentOS: sudo yum install curl"
    exit 1
fi

# Self-elevate to root if not already
if [ "$(id -u)" -ne 0 ]; then
    log_info "Elevating permissions to root..."
    # shellcheck disable=SC2093
    exec sudo "$0" "$@" # Re-run the script with sudo
    log_error "Failed to elevate to root. Please run with sudo." # This will only run if exec fails
    exit 1
fi

if [ -z "$ODOO_DATABASE_NAME_PRD" ]; then
    read -rp "Enter the database name: " ODOO_DATABASE_NAME_PRD
fi

if [ -z "$ADMIN_PASSWD" ] || [ -z "$PORT" ]; then
    log_error "ADMIN_PASSWD and/or PORT not set in .env file. Cannot proceed with backup."
    exit 1
fi

checkOdooEndpoint

log_info "Start backup for database '$ODOO_DATABASE_NAME_PRD' from service '$SERVICE_NAME'"

if [ -f "$BACKUP_FILE_PATH" ]; then
    log_warn "Backup file already exists. Removing it..."
    rm -f "$BACKUP_FILE_PATH"
fi

log_info "Requesting backup from Odoo..."
curl -s -X POST \
     -F "master_pwd=$ADMIN_PASSWD" \
     -F "name=$ODOO_DATABASE_NAME_PRD" \
     -F "backup_format=zip" \
     -o "$BACKUP_FILE_PATH" \
     "http://localhost:$PORT/web/database/backup"

if [ -s "$BACKUP_FILE_PATH" ]; then
    MIME_TYPE=$(file -b --mime-type "$BACKUP_FILE_PATH")
    if [[ "$MIME_TYPE" != "application/zip" ]]; then
        response=$(head -c 5000 "$BACKUP_FILE_PATH")
        response_lower="${response,,}"

        if [[ "$response_lower" == *"error"* ]] && [[ "$response_lower" != *"does not exist"* ]] || \
           [[ "$response_lower" == *"no space left"* ]] || \
           [[ "$response_lower" == *"<html"* ]]; then

            if [[ "$response_lower" == *"<html"* ]]; then
                ODOO_ERROR_MSG=$(grep -a '<div class="alert alert-danger">' "$BACKUP_FILE_PATH" | sed -n 's/.*<div class="alert alert-danger">\(.*\)<\/div>.*/\1/p')

                if [ -z "$ODOO_ERROR_MSG" ]; then
                    ODOO_ERROR_MSG="Unknown error (The response was an HTML page, but the specific error message could not be parsed)."
                fi

                log_error "Backup failed! Odoo returned an HTML error page instead of a ZIP file."
                log_error "Odoo Message: $ODOO_ERROR_MSG"
            else
                log_error "Backup failed! Response: $response"
            fi
            exit 1
        fi
    fi

    chown "$SUDO_USER:$SUDO_USER" "$BACKUP_FILE_PATH"
    log_success "Backup for '$ODOO_DATABASE_NAME_PRD' is completed. The backup file is located at $BACKUP_FILE_PATH."
else
    log_error "Backup failed. The output file is empty. Check Odoo logs for details. Is the master password correct?"
    exit 1
fi
