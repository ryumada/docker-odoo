#!/usr/bin/env bash
set -e
# Category: Utility
# Description: Restores Odoo data via the web endpoint.
# Usage: ./scripts/restore_backupdata.sh
# Dependencies: curl, sudo, git

# Detect Repository Owner to run non-root commands as that user
CURRENT_DIR=$(dirname "$(readlink -f "$0")")
CURRENT_DIR_USER=$(stat -c '%U' "$CURRENT_DIR")
PATH_TO_ODOO=$(sudo -u "$CURRENT_DIR_USER" git -C "$(dirname "$(readlink -f "$0")")" rev-parse --show-toplevel)
SERVICE_NAME=$(basename "$PATH_TO_ODOO")
REPOSITORY_OWNER=$(stat -c '%U' "$PATH_TO_ODOO")

# Configuration
ENV_FILE=".env"
UPDATE_SCRIPT="./scripts/update-env-file.sh"
MAX_BACKUPS=3

# --- Logging Functions & Colors ---
# Define colors for log messages
readonly COLOR_RESET="\033[0m"
readonly COLOR_INFO="\033[0;34m"
readonly COLOR_SUCCESS="\033[0;32m"
readonly COLOR_WARN="\033[1;33m"
readonly COLOR_ERROR="\033[0;31m"

# Function to log messages with a specific color and emoji
log() {
  local color="$1"
  local emoji="$2"
  local message="$3"
  echo -e "${color}[$(date +"%Y-%m-%d %H:%M:%S")] ${emoji} ${message}${COLOR_RESET}"
}

log_info() { log "${COLOR_INFO}" "ℹ️" "$1"; }
log_success() { log "${COLOR_SUCCESS}" "✅" "$1"; }
log_warn() { log "${COLOR_WARN}" "⚠️" "$1"; }
log_error() { log "${COLOR_ERROR}" "❌" "$1"; }
# ------------------------------------

function generate_passphrase() {
  local consonants="bcdfghjklmnpqrstvwxyz"
  local vowels="aeiou"
  local word=""
  for i in {1..4}; do
    word+="${consonants:RANDOM%21:1}"
    word+="${vowels:RANDOM%5:1}"
  done
  echo "$word"
}

function error_handler() {
  log_error "Error on line $1"
  exit 1
}

function isBackupDataExists() {
  backupdata_file_path="$1"
  if [ ! -f "$backupdata_file_path" ]; then
    log_error "Backup data file $backupdata_file_path does not exist. Please place your backupdata file on /tmp directory."
    exit 1
  fi
}

function isCurlInstalled() {
  if ! command -v curl &>/dev/null; then
    log_error "curl is not installed. Please install curl."
    echo "Ubuntu: sudo apt install curl"
    echo "CentOS: sudo yum install curl"
    exit 1
  fi
}

function checkOdooEndpoint() {
  log_info "Checking if Odoo endpoint is accessible on port $PORT..."
  if curl --output /dev/null --silent --head --fail "http://localhost:$PORT"; then
    log_success "Odoo endpoint is accessible."
  else
    log_warn "Odoo endpoint is NOT accessible at http://localhost:$PORT. Retrying with longer timeout..."
    if curl --output /dev/null --silent --head --fail --connect-timeout 10 "http://localhost:$PORT"; then
      log_success "Odoo endpoint is accessible."
    else
      log_error "Odoo endpoint is NOT accessible at http://localhost:$PORT. Please check if the service is running."
      exit 1
    fi
  fi
}

function restoreOdooDataViaEndpoint() {
  # Note: ENV_FILE_FULL_PATH is used here (which defaults to $PATH_TO_ODOO/.env)
  NEUTRALIZE_DB=$(grep "^NEUTRALIZE_DATABASE=" "$ENV_FILE_FULL_PATH" | cut -d "=" -f 2 | sed 's/^[[:space:]\n]*//g' | sed 's/[[:space:]\n]*$//g')
  if [ -z "$NEUTRALIZE_DB" ]; then
    NEUTRALIZE_DB="true"
  fi

  log_info "Restoring database via Odoo endpoint..."
  log_info "Neutralize database option: $NEUTRALIZE_DB"

  if [ "$NEUTRALIZE_DB" = "true" ]; then
    response=$(curl -s -X POST \
      -F "master_pwd=$ADMIN_PASSWD" \
      -F "name=$RESTORED_DB_NAME" \
      -F "backup_file=@$BACKUPDATA_FILE_PATH" \
      -F "copy=true" \
      -F "neutralize_database=$NEUTRALIZE_DB" \
      "http://localhost:$PORT/web/database/restore")
  else
    response=$(curl -s -X POST \
      -F "master_pwd=$ADMIN_PASSWD" \
      -F "name=$RESTORED_DB_NAME" \
      -F "backup_file=@$BACKUPDATA_FILE_PATH" \
      -F "copy=true" \
      "http://localhost:$PORT/web/database/restore")
  fi

  if [[ "$response" != *"error"* ]] && [[ "$response" != *"incorrect master password"* ]]; then
    log_success "Database restore command sent successfully."
  else
    log_error "Failed to restore database via endpoint. Response: $response"
    exit 1
  fi
}

trap 'error_handler $LINENO' ERR

function main() {
  ENV_FILE_FULL_PATH="$PATH_TO_ODOO/.env"
  BACKUPDATA_FILE_NAME="backupdata-$SERVICE_NAME.zip"
  BACKUPDATA_FILE_PATH="/tmp/$BACKUPDATA_FILE_NAME"
  RESTORED_DB_NAME=""

  ADMIN_PASSWD=$(grep "^ADMIN_PASSWD=" "$ENV_FILE_FULL_PATH" | cut -d "=" -f 2 | sed 's/^[[:space:]\n]*//g' | sed 's/[[:space:]\n]*$//g')
  PORT=$(grep "^PORT=" "$ENV_FILE_FULL_PATH" | cut -d "=" -f 2 | sed 's/^[[:space:]\n]*//g' | sed 's/[[:space:]\n]*$//g')
  if [ -z "$ADMIN_PASSWD" ] || [ -z "$PORT" ]; then
      log_error "ADMIN_PASSWD and/or PORT not set in .env file. Cannot proceed with restore."
      exit 1
  fi

    # Self-elevate to root if not already
  if [ "$(id -u)" -ne 0 ]; then
      log_info "Elevating permissions to root..."
      # shellcheck disable=SC2093
      exec sudo "$0" "$@" # Re-run the script with sudo
      log_error "Failed to elevate to root. Please run with sudo." # This will only run if exec fails
      exit 1
  fi

  isBackupDataExists "$BACKUPDATA_FILE_PATH"
  isCurlInstalled
  checkOdooEndpoint

  log_info "Start restoring backup data for $SERVICE_NAME"

  while true; do

    PROMPT_FOR_DATABASE_NAME=$(grep "^PROMPT_FOR_DATABASE_NAME=" "$PATH_TO_ODOO/.env" | cut -d "=" -f 2 | sed 's/^[[:space:]\n]*//g' | sed 's/[[:space:]\n]*$//g')
    if [ -z "$PROMPT_FOR_DATABASE_NAME" ]; then
      ODOO_DATABASE_NAME_PRD=$(grep "^DB_NAME=" "$PATH_TO_ODOO/.env" | cut -d "=" -f 2 | sed 's/^[[:space:]\n]*//g' | sed 's/[[:space:]\n]*$//g')
      if [ -z "$ODOO_DATABASE_NAME_PRD" ]; then
        RESTORED_DB_NAME="$(generate_passphrase)-$(date +"%Y%m%d-%H%M%S")"
      else
        RESTORED_DB_NAME="$(generate_passphrase)-$(date +"%Y%m%d-%H%M%S")"
      fi
    else
      read -rp "Enter the new database name: " RESTORED_DB_NAME
    fi

    log_info "Database name would be $RESTORED_DB_NAME"

    log_info "Checking if the database exists"
    if sudo -u postgres psql -lqt | cut -d \| -f 1 | grep -qw "$RESTORED_DB_NAME"; then
      log_warn "Database $RESTORED_DB_NAME exists. Initiating safety backup..."

      SAFETY_BACKUP_NAME="backupdata-$SERVICE_NAME-safety-backup-$(date +"%Y%m%d-%H%M%S").zip"
      SAFETY_BACKUP_PATH="/tmp/$SAFETY_BACKUP_NAME"

      log_info "Creating safety backup at $SAFETY_BACKUP_PATH"
      curl -s -X POST \
        -F "master_pwd=$ADMIN_PASSWD" \
        -F "name=$RESTORED_DB_NAME" \
        -F "backup_format=zip" \
        -o "$SAFETY_BACKUP_PATH" \
        "http://localhost:$PORT/web/database/backup"

      if [ -s "$SAFETY_BACKUP_PATH" ]; then
        log_success "Safety backup created successfully."
      else
        log_error "Safety backup failed. The output file is empty. Aborting restore to prevent data loss."
        rm -f "$SAFETY_BACKUP_PATH"
        exit 1
      fi

      log_info "Dropping existing database $RESTORED_DB_NAME..."
      # Try dropping via API first
      drop_response=$(curl -s -X POST \
        -F "master_pwd=$ADMIN_PASSWD" \
        -F "name=$RESTORED_DB_NAME" \
        "http://localhost:$PORT/web/database/drop")

      # Verify Drop - if API returned valid HTML/JSON it might still have failed, so we check existence again or check response
      # Simplest is to check existence via psql again
      if sudo -u postgres psql -lqt | cut -d \| -f 1 | grep -qw "$RESTORED_DB_NAME"; then
         log_warn "API drop might have failed or is slow. Attempting force drop via psql..."
         if sudo -u postgres psql -c "DROP DATABASE \"$RESTORED_DB_NAME\"" >/dev/null 2>&1; then
             log_success "Database dropped via psql."
             
             # Also drop the filestore
             ODOO_FILESTORE_PATH="/var/lib/odoo/$SERVICE_NAME/filestore/$RESTORED_DB_NAME"
             if [ -d "$ODOO_FILESTORE_PATH" ]; then
                 log_info "Removing filestore at $ODOO_FILESTORE_PATH..."
                 sudo rm -rf "$ODOO_FILESTORE_PATH"
                 log_success "Filestore removed."
             fi
         else
             log_error "Failed to drop database $RESTORED_DB_NAME. Cannot proceed."
             exit 1
         fi
      else
         log_success "Database dropped successfully via API."
      fi

      break
    else
      log_success "Database $RESTORED_DB_NAME does not exist"
      break
    fi
  done

  restoreOdooDataViaEndpoint

  log_success "Finish restoring backup data for $SERVICE_NAME"
}

main "$@"
