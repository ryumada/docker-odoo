#!/bin/bash

# Exit immediately if a command exits with a non-zero status
set -Eeuo pipefail

error_handler() {
  log_error "An error occurred on line $1. Exiting..."
  exit 1
}

trap 'error_handler $LINENO' ERR

# --- Logging Functions & Colors ---
# Define colors for log messages
readonly COLOR_RESET="\033[0m"
readonly COLOR_INFO="\033[0;34m"
readonly COLOR_SUCCESS="\033[0;32m"
readonly COLOR_WARN="\033[0;33m"
readonly COLOR_ERROR="\033[0;31m"

# Function to log messages with a specific color and emoji
log() {
  local color="$1"
  local emoji="$2"
  local message="$3"
  echo -e "${color}[$(date +"%Y-%m-%d %H:%M:%S")] ${emoji} ${message}${COLOR_RESET}"
}

log_info() { log "${COLOR_INFO}" "ℹ️" "$1"; }
log_success() { log "${COLOR_SUCCESS}" "✅" "$1"; }
log_warn() { log "${COLOR_WARN}" "⚠️" "$1"; }
log_error() { log "${COLOR_ERROR}" "❌" "$1"; }
# ------------------------------------

function promptWhichEnvironment() {
  local environment="$1"
  local ODOO_DEPLOYMENT_ENVIRONMENT

  if [ "$environment" == "" ]; then
    # You need to choose whether there are multiple environments for your deployment
    while true; do
      read -rp "Which environment you wish to clone the data to?
      [1] Development (dev)
      [2] Staging (stg)
      [3] Testing (tst)
      [4] Other

      Enter the number 1 - 4: " ODOO_DEPLOYMENT_ENVIRONMENT

      if [[ ! "$ODOO_DEPLOYMENT_ENVIRONMENT" =~ ^[1-9]+$ ]]; then
        log_error "Invalid input. Please enter a number base on the menu above."
        continue
      fi

      case $ODOO_DEPLOYMENT_ENVIRONMENT in
        1)
          ODOO_DEPLOYMENT_ENVIRONMENT=dev
          break
          ;;
        2)
          ODOO_DEPLOYMENT_ENVIRONMENT=stg
          break
          ;;
        3)
          ODOO_DEPLOYMENT_ENVIRONMENT=tst
          break
          ;;
        4)
          read -rp "Enter the environment name: " ODOO_DEPLOYMENT_ENVIRONMENT
          break
          ;;
        *)
          log_error "Invalid option"
          ;;
      esac
    done
  else
    ODOO_DEPLOYMENT_ENVIRONMENT=$environment
  fi

  echo "$ODOO_DEPLOYMENT_ENVIRONMENT"
}

function promptDBNameSuffix() {
  local promptDBNameSuffix="$1"
  local ODOO_DEPLOYMENT_ENVIRONMENT="$2"

  local ODOO_DB_NAME_ENV

  case "$promptDBNameSuffix" in
    Y|y)
      ODOO_DB_NAME_ENV="$ODOO_DATABASE_NAME_PRD-$ODOO_DEPLOYMENT_ENVIRONMENT-$(date +"%Y%m%d_%H%M")"
      ;;
    prompt)
      while true; do
        read -rp "Do you want to use a date suffix for the new database name? [Y/n]: " USE_DATE_SUFFIX

        case "$USE_DATE_SUFFIX" in
          Y|y)
            ODOO_DB_NAME_ENV="$ODOO_DATABASE_NAME_PRD-$ODOO_DEPLOYMENT_ENVIRONMENT-$(date +"%Y%m%d_%H%M")"; break ;;
          N|n)
            ODOO_DB_NAME_ENV="$ODOO_DATABASE_NAME_PRD-$ODOO_DEPLOYMENT_ENVIRONMENT"; break ;;
          *)
            log_error "Invalid option" ;;
        esac
      done
      ;;
    *)
      ODOO_DB_NAME_ENV="$ODOO_DATABASE_NAME_PRD-$ODOO_DEPLOYMENT_ENVIRONMENT"
      ;;
  esac

  echo "$ODOO_DB_NAME_ENV"
}

function main() {
  # Self-elevate to root if not already
  if [ "$(id -u)" -ne 0 ]; then
      log_info "Elevating permissions to root..."
      # shellcheck disable=SC2093
      exec sudo "$0" "$@" # Re-run the script with sudo
      log_error "Failed to elevate to root. Please run with sudo." # This will only run if exec fails
      exit 1
  fi

  CURRENT_DIR=$(dirname "$(readlink -f "$0")")
  CURRENT_DIR_USER=$(stat -c '%U' "$CURRENT_DIR")
  PATH_TO_ODOO=$(sudo -u "$CURRENT_DIR_USER" git -C "$(dirname "$(readlink -f "$0")")" rev-parse --show-toplevel)
  SERVICE_NAME=$(basename "$PATH_TO_ODOO")
  TEMP_BACKUP_FILE="/tmp/cloner_backup-$SERVICE_NAME.zip"

  # Source environment details
  SOURCE_ADMIN_PASSWD=$(grep "^ADMIN_PASSWD=" "$PATH_TO_ODOO/.env" | cut -d "=" -f 2 | sed 's/^[[:space:]\n]*//g' | sed 's/[[:space:]\n]*$//g')
  SOURCE_PORT=$(grep "^PORT=" "$PATH_TO_ODOO/.env" | cut -d "=" -f 2 | sed 's/^[[:space:]\n]*//g' | sed 's/[[:space:]\n]*$//g')

  ODOO_DATABASE_NAME_PRD=$(grep "^DB_NAME=" "$PATH_TO_ODOO/.env" | cut -d "=" -f 2 | sed 's/^[[:space:]\n]*//g' | sed 's/[[:space:]\n]*$//g')
  if [ -z "$ODOO_DATABASE_NAME_PRD" ]; then
    read -rp "Enter the database name: " ODOO_DATABASE_NAME_PRD
  fi

  ## The environment to which the database will be cloned (leave empty to prompt)
  CLONED_ENV=$(grep "^CLONED_ENV=" "$PATH_TO_ODOO/.env" | cut -d "=" -f 2 | sed 's/^[[:space:]\n]*//g' | sed 's/[[:space:]\n]*$//g')

  ## ex. Y (replace with Y if you want to use a date suffix for the new database name)
  # This variable determines whether to use a date suffix for the new database name
  USE_DATE_SUFFIX=$(grep "^USE_DATE_SUFFIX=" "$PATH_TO_ODOO/.env" | cut -d "=" -f 2 | sed 's/^[[:space:]\n]*//g' | sed 's/[[:space:]\n]*$//g')

  ODOO_DEPLOYMENT_ENVIRONMENT=$(promptWhichEnvironment "$CLONED_ENV")

  PATH_TO_ODOO_ENV="$PATH_TO_ODOO/../$SERVICE_NAME-$ODOO_DEPLOYMENT_ENVIRONMENT"

  if [ ! -d "$PATH_TO_ODOO_ENV" ]; then
    log_error "The destination deployment environment '$SERVICE_NAME-$ODOO_DEPLOYMENT_ENVIRONMENT' does not exist at '$PATH_TO_ODOO_ENV'"
    exit 1
  fi

  # Destination environment details
  DEST_ADMIN_PASSWD=$(grep "^ADMIN_PASSWD=" "$PATH_TO_ODOO_ENV/.env" | cut -d "=" -f 2 | sed 's/^[[:space:]\n]*//g' | sed 's/[[:space:]\n]*$//g')
  DEST_PORT=$(grep "^PORT=" "$PATH_TO_ODOO_ENV/.env" | cut -d "=" -f 2 | sed 's/^[[:space:]\n]*//g' | sed 's/[[:space:]\n]*$//g')

  if [ -z "$SOURCE_ADMIN_PASSWD" ] || [ -z "$SOURCE_PORT" ] || [ -z "$DEST_ADMIN_PASSWD" ] || [ -z "$DEST_PORT" ]; then
    log_error "ADMIN_PASSWD and/or PORT not set in the .env file of the source or destination environment."
    exit 1
  fi

  ODOO_DB_NAME_ENV=$(promptDBNameSuffix "$USE_DATE_SUFFIX" "$ODOO_DEPLOYMENT_ENVIRONMENT")

  log_info "Start cloning database from '$ODOO_DATABASE_NAME_PRD' to '$ODOO_DB_NAME_ENV'"

  # 1. Backup source database using curl
  log_info "Requesting backup from source Odoo instance..."
  curl -s -X POST \
       -F "master_pwd=$SOURCE_ADMIN_PASSWD" \
       -F "name=$ODOO_DATABASE_NAME_PRD" \
       -F "backup_format=zip" \
       -o "$TEMP_BACKUP_FILE" \
       "http://localhost:$SOURCE_PORT/web/database/backup"

  if [ ! -s "$TEMP_BACKUP_FILE" ]; then
      log_error "Backup failed. The output file is empty or was not created. Check source Odoo logs."
      exit 1
  fi
  log_success "Backup of '$ODOO_DATABASE_NAME_PRD' completed successfully to $TEMP_BACKUP_FILE"

  # 2. Restore to destination database using curl
  log_info "Stopping the destination environment '$ODOO_DEPLOYMENT_ENVIRONMENT' before restore..."
  if ! docker compose -f "$PATH_TO_ODOO_ENV/docker-compose.yml" stop > /dev/null 2>&1; then
    log_warn "Could not stop destination environment. It might not be running."
  fi

  log_info "Dropping old database '$ODOO_DB_NAME_ENV' if it exists..."
  if ! sudo -u postgres psql -c "DROP DATABASE IF EXISTS \"$ODOO_DB_NAME_ENV\" WITH (FORCE);" > /dev/null 2>&1; then
    log_warn "Could not drop database '$ODOO_DB_NAME_ENV'. It might not exist."
  fi

  log_info "Requesting restore to destination Odoo instance..."
  response=$(curl -s -X POST \
    -F "master_pwd=$DEST_ADMIN_PASSWD" \
    -F "name=$ODOO_DB_NAME_ENV" \
    -F "backup_file=@$TEMP_BACKUP_FILE" \
    -F "copy=true" \
    "http://localhost:$DEST_PORT/web/database/restore")

  if [[ "$response" == *"error"* ]] || [[ "$response" == *"incorrect master password"* ]]; then
    log_error "Failed to restore database to destination. Response: $response"
    rm -f "$TEMP_BACKUP_FILE"
    exit 1
  fi
  log_success "Database restore command sent successfully to destination."

  log_info "Cleaning up temporary backup file..."
  rm -f "$TEMP_BACKUP_FILE"

  log_info "Restarting the destination environment '$ODOO_DEPLOYMENT_ENVIRONMENT'..."
  docker compose -f "$PATH_TO_ODOO_ENV/docker-compose.yml" up -d > /dev/null 2>&1 || { log_error "Error restarting $ODOO_DEPLOYMENT_ENVIRONMENT"; exit 1; }

  log_success "Finish cloning database '$ODOO_DB_NAME_ENV' from '$ODOO_DATABASE_NAME_PRD'"
}

main "@"
