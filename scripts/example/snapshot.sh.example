#!/usr/bin/env bash
set -e
# Category: Utility
# Description: Manages Odoo snapshots (Create, List, Restore).
# Usage: ./scripts/snapshot.sh {create|list|restore} [options]
# Dependencies: docker, sudo, zstd, tar, pg_dump, psql

# Detect Repository Owner to run non-root commands as that user
CURRENT_DIR=$(dirname "$(readlink -f "$0")")
CURRENT_DIR_USER=$(stat -c '%U' "$CURRENT_DIR")
PATH_TO_ODOO=$(sudo -u "$CURRENT_DIR_USER" git -C "$(dirname "$(readlink -f "$0")")" rev-parse --show-toplevel)
SERVICE_NAME=$(basename "$PATH_TO_ODOO")
REPOSITORY_OWNER=$(stat -c '%U' "$PATH_TO_ODOO")

# Configuration
ENV_FILE=".env"
UPDATE_SCRIPT="./scripts/update-env-file.sh"
MAX_BACKUPS=3

# --- Logging Functions & Colors ---
# Define colors for log messages
readonly COLOR_RESET="\033[0m"
readonly COLOR_INFO="\033[0;34m"
readonly COLOR_SUCCESS="\033[0;32m"
readonly COLOR_WARN="\033[1;33m"
readonly COLOR_ERROR="\033[0;31m"

# Function to log messages with a specific color and emoji
log() {
  local color="$1"
  local emoji="$2"
  local message="$3"
  echo -e "${color}[$(date +"%Y-%m-%d %H:%M:%S")] ${emoji} ${message}${COLOR_RESET}"
}

log_info() { log "${COLOR_INFO}" "ℹ️" "$1"; }
log_success() { log "${COLOR_SUCCESS}" "✅" "$1"; }
log_warn() { log "${COLOR_WARN}" "⚠️" "$1"; }
log_error() { log "${COLOR_ERROR}" "❌" "$1"; }
# ------------------------------------

# Self-elevate to root if not already
if [ "$(id -u)" -ne 0 ]; then
    log_info "Elevating permissions to root..."
    # shellcheck disable=SC2093
    exec sudo "$0" "$@" # Re-run the script with sudo
    log_error "Failed to elevate to root. Please run with sudo." # This will only run if exec fails
    exit 1
fi

error_handler() {
    log_error "An error occurred on line $1"
}
trap 'error_handler $LINENO' ERR

# --- Configuration ---
SNAPSHOT_DIR="$PATH_TO_ODOO/snapshots"
DB_NAME=$(grep "^DB_NAME=" "$PATH_TO_ODOO/.env" | cut -d "=" -f 2 | sed 's/^[[:space:]\n]*//g' | sed 's/[[:space:]\n]*$//g')
DATA_DIR="/var/lib/odoo"
FILESTORE_DIR="$DATA_DIR/$SERVICE_NAME/filestore/$DB_NAME"

# Check dependencies
for cmd in docker sudo zstd tar pg_dump psql; do
    if ! command -v $cmd &> /dev/null; then
        log_error "$cmd could not be found. Please install it."
        exit 1
    fi
done

mkdir -p "$SNAPSHOT_DIR"
chown "$REPOSITORY_OWNER:$REPOSITORY_OWNER" "$SNAPSHOT_DIR"

# --- Functions ---

function create_snapshot() {
    local snapshot_name="snapshot_$(date +%Y%m%d_%H%M%S)"
    local snapshot_path="$SNAPSHOT_DIR/$snapshot_name"
    
    log_info "Creating snapshot: $snapshot_name"
    mkdir -p "$snapshot_path"

    # Database Dump
    log_info "Dumping database $DB_NAME..."
    if sudo -u postgres pg_dump -F c -b -v -f "$snapshot_path/db_dump.sql" "$DB_NAME"; then
        log_success "Database dump successful."
    else
        log_error "Database dump failed."
        rm -rf "$snapshot_path"
        exit 1
    fi

    # Filestore Backup
    if [ -d "$FILESTORE_DIR" ]; then
        log_info "Backing up filestore..."
        tar --use-compress-program=zstd -cf "$snapshot_path/filestore.tar.zst" -C "$(dirname "$FILESTORE_DIR")" "$(basename "$FILESTORE_DIR")"
        log_success "Filestore backup successful."
    else
        log_warn "Filestore directory not found at $FILESTORE_DIR. Skipping filestore backup."
    fi

    # Metadata
    echo "Date: $(date)" > "$snapshot_path/metadata.txt"
    echo "Database: $DB_NAME" >> "$snapshot_path/metadata.txt"
    echo "Service: $SERVICE_NAME" >> "$snapshot_path/metadata.txt"

    # Compress the entire snapshot directory
    log_info "Compressing snapshot..."
    tar --use-compress-program=zstd -cf "$SNAPSHOT_DIR/$snapshot_name.tar.zst" -C "$SNAPSHOT_DIR" "$snapshot_name"
    rm -rf "$snapshot_path"

    log_success "Snapshot created at: $SNAPSHOT_DIR/$snapshot_name.tar.zst"
    
    # Cleanup old snapshots
    # (Optional: remove older than N days or keep only latest N)
}

function list_snapshots() {
    log_info "Available Snapshots:"
    ls -lh "$SNAPSHOT_DIR"/*.tar.zst 2>/dev/null || log_warn "No snapshots found."
}

function restore_snapshot() {
    local snapshot_file="$1"
    
    if [ -z "$snapshot_file" ]; then
        list_snapshots
        read -rp "Enter the filename of the snapshot to restore: " snapshot_file
    fi

    if [[ ! "$snapshot_file" == /* ]]; then
        snapshot_file="$SNAPSHOT_DIR/$snapshot_file"
    fi

    if [ ! -f "$snapshot_file" ]; then
        log_error "Snapshot file not found: $snapshot_file"
        exit 1
    fi

    log_warn "WARNING: This will overwrite the current database '$DB_NAME' and filestore."
    read -rp "Are you sure? [y/N]: " confirm
    if [[ "$confirm" != "y" && "$confirm" != "Y" ]]; then
        log_info "Restore cancelled."
        exit 0
    fi

    log_info "Restoring from $snapshot_file..."
    
    local temp_dir
    temp_dir=$(mktemp -d)
    
    log_info "Extracting snapshot..."
    tar --use-compress-program=zstd -xf "$snapshot_file" -C "$temp_dir"
    
    local snapshot_folder
    snapshot_folder=$(ls "$temp_dir")
    local snapshot_root="$temp_dir/$snapshot_folder"

    # Restore Database
    log_info "Dropping existing database..."
    if sudo -u postgres psql -c "DROP DATABASE IF EXISTS \"$DB_NAME\""; then
         log_success "Database dropped."
    else
         log_error "Failed to drop database."
         rm -rf "$temp_dir"
         exit 1
    fi

    log_info "Creating database..."
    if sudo -u postgres psql -c "CREATE DATABASE \"$DB_NAME\""; then
         log_success "Database created."
    else
         log_error "Failed to create database."
         rm -rf "$temp_dir"
         exit 1
    fi

    log_info "Restoring database dump..."
    if sudo -u postgres pg_restore -d "$DB_NAME" -v "$snapshot_root/db_dump.sql"; then
         log_success "Database restored."
    else
         log_warn "pg_restore finished with errors (check output). proceeding..."
    fi

    # Restore Filestore
    if [ -f "$snapshot_root/filestore.tar.zst" ]; then
        log_info "Restoring filestore..."
        rm -rf "$FILESTORE_DIR"
        mkdir -p "$(dirname "$FILESTORE_DIR")"
        tar --use-compress-program=zstd -xf "$snapshot_root/filestore.tar.zst" -C "$(dirname "$FILESTORE_DIR")"
        chown -R odoo:odoo "$FILESTORE_DIR"
        log_success "Filestore restored."
    fi

    rm -rf "$temp_dir"
    
    log_info "Restarting Odoo..."
    docker compose restart odoo

    log_success "Restore complete."
}

# --- Main ---
case "$1" in
    create)
        create_snapshot
        ;;
    list)
        list_snapshots
        ;;
    restore)
        restore_snapshot "$2"
        ;;
    *)
        echo "Usage: $0 {create|list|restore}"
        exit 1
        ;;
esac
