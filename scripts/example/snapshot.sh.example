#!/bin/bash

CURRENT_DIR=$(dirname "$(readlink -f "$0")")
CURRENT_DIR_USER=$(stat -c '%U' "$CURRENT_DIR")
PATH_TO_ODOO=$(sudo -u "$CURRENT_DIR_USER" git -C "$(dirname "$(readlink -f "$0")")" rev-parse --show-toplevel)
SERVICE_NAME=$(basename "$PATH_TO_ODOO")
REPOSITORY_OWNER=$(stat -c '%U' "$PATH_TO_ODOO")

# --- Logging Functions & Colors ---
# Define colors for log messages
readonly COLOR_RESET="\033[0m"
readonly COLOR_INFO="\033[0;34m"
readonly COLOR_SUCCESS="\033[0;32m"
readonly COLOR_WARN="\033[0;33m"
readonly COLOR_ERROR="\033[0;31m"

# Function to log messages with a specific color and emoji
log() {
  local color="$1"
  local emoji="$2"
  local message="$3"
  echo -e "${color}[$(date +"%Y-%m-%d %H:%M:%S")] ${emoji} ${message}${COLOR_RESET}"
}

log_info() { log "${COLOR_INFO}" "ℹ️" "$1"; }
log_success() { log "${COLOR_SUCCESS}" "✅" "$1"; }
log_warn() { log "${COLOR_WARN}" "⚠️" "$1"; }
log_error() { log "${COLOR_ERROR}" "❌" "$1"; }
# ------------------------------------

function areYouReallySure() {
  tar_file_path=$1
  ASK_TO_REPLACE_EXISTING_SNAPSHOT=$2
  if [ -f "$tar_file_path" ]; then
    if [ "$ASK_TO_REPLACE_EXISTING_SNAPSHOT" == "Y" ]; then
      echo "current snapshot file already exists, do you want to overwrite it? ($tar_file_path)"
      echo -e "type 'yes I am sure' to continue.\n"

      read -rp ": " CONFIRMATION

      case $CONFIRMATION in
        "yes I am sure")
          log_info "Overwriting the current snapshot file."
          rm -f "$tar_file_path"
          ;;
        *)
          log_error "You're not sure, okay. Now exiting the script."
          exit 1
          ;;
      esac
    else
      log_info "Removing the existing snapshot file."
      rm -f "$tar_file_path"
    fi
  fi
}

function getGitHash() {
  # _inherit = writeGitHash

  git_path=$1
  git_real_owner=$(stat -c '%U' "$git_path")
  repository_owner=$(stat -c '%U' "$PATH_TO_ODOO")

  chown -R "$repository_owner": "$git_path"

  OUTPUT_GIT_HASHES_FILE="$git_path/../git_hashes.txt"

  cat <<EOF >> "$OUTPUT_GIT_HASHES_FILE"
  Updated at [$(date +"%Y-%m-%d %H:%M:%S")]
  Git Directory: $git_path
  Git Remote: $(git -C "$git_path" remote get-url origin)
  Git Branch: $(git -C "$git_path" branch --show-current)
  Git Hashes: $(git -C "$git_path" rev-parse HEAD)
EOF

  chown -R "$git_real_owner": "$git_path"
}

function getSubDirectories() {
  dir=$1
  subdirs="$(ls -d "$dir"/*/)"
  echo "$subdirs"
}

function isDirectoryGitRepository() {
  # _inherit = writeGitHash

  dir=$1

  if [ -d "$dir/.git" ]; then
    if git rev-parse --is-inside-work-tree &>/dev/null; then
      return 0
    else
      return 1
    fi
  else
    return 1
  fi
}

function moveSnapshotFileToTempDir() {
  local tar_file_path=$1
  local tar_file_name=$2

  local temp_dir
  temp_dir="$tar_file_path-$(date +"%Y%m%d-%H%M%S")"
  if ! OUTPUT_mkdir=$(mkdir "$temp_dir" 2>&1); then
    log_error "Can't create the temporary directory: $OUTPUT_mkdir"
    exit 1
  else
    log_success "Create the temporary directory"
  fi

  log_info "Moving the snapshot file to the temporary directory."
  mv "$tar_file_path" "$temp_dir/"

  log_info "change the permission and owner of the temporary directory"
  chmod 755 "$temp_dir"
  chmod 644 "$temp_dir/$tar_file_name"
  chown -R "$REPOSITORY_OWNER": "$temp_dir"

  log_success "The snapshot File Created Successfully named $tar_file_name. File Backed up at $temp_dir/$tar_file_name"
}

function resetGitHashFile(){
  # _inherit = writeGitHash

  git_path=$1
  OUTPUT_GIT_HASHES_FILE="$git_path/../git_hashes.txt"

  cat <<EOF > "$OUTPUT_GIT_HASHES_FILE"

EOF
}

function writeGitHash() {
  dir=$1
  subdirs="$(getSubDirectories "$dir")"

  flag=0
  for dir in $subdirs; do

    if [ $flag -eq 0 ]; then
      resetGitHashFile "$dir"
      flag=1
    fi

    if isDirectoryGitRepository "$dir"; then
      getGitHash "$dir"
    else
      log_warn "$dir is not a git repository. You need to backup this directory by adding it to your snapshot utilities."
    fi
  done
}

function main() {
  LOG_PATH=/var/log/odoo/_utilities/snapshot-$SERVICE_NAME.log

  # Redirect stdout and stderr to tee
  exec > >(tee -a "$LOG_PATH") 2>&1

  # Self-elevate to root if not already
  if [ "$(id -u)" -ne 0 ]; then
      log_info "Elevating permissions to root..."
      # shellcheck disable=SC2093
      exec sudo "$0" "$@" # Re-run the script with sudo
      log_error "Failed to elevate to root. Please run with sudo." # This will only run if exec fails
      exit 1
  fi

  # Setup cleanup trap
  SQL_DUMP_FILE=""
  cleanup() {
      if [[ -n "$SQL_DUMP_FILE" && -f "$SQL_DUMP_FILE" ]]; then
          rm -f "$SQL_DUMP_FILE"
      fi
  }
  trap cleanup EXIT

  echo "-------------------------------------------------------------------------------"
  echo " DAILY SNAPSHOT FOR $SERVICE_NAME @ $(date +"%A, %d %B %Y %H:%M %Z")"
  echo "-------------------------------------------------------------------------------"

  # enter the production database name this is required to backup the database
  # Robust parsing for DB_NAME
  ODOO_DATABASE_NAME_PRD=$(grep "^DB_NAME=" "$PATH_TO_ODOO/.env" | cut -d '=' -f2- | sed 's/^[[:space:]]*//;s/[[:space:]]*$//;s/^["'\'']//;s/["'\'']$//')

  if [ -z "$ODOO_DATABASE_NAME_PRD" ]; then
    log_error "Please setup DB_NAME in your .env file!"
    exit 1
  fi

  # ask to replace the existing snapshot file
  # enter "Y" to add question to replace the existing snapshot file
  ASK_TO_REPLACE_EXISTING_SNAPSHOT=$(grep "^ASK_TO_REPLACE_EXISTING_SNAPSHOT=" "$PATH_TO_ODOO/.env" | cut -d '=' -f2- | sed 's/^[[:space:]]*//;s/[[:space:]]*$//;s/^["'\'']//;s/["'\'']$//')

  # you can leave it as is to back up to the /tmp directory instead of Google Cloud Storage (GCS)
  GCS_BUCKET_NAME=$(grep "^GCS_BUCKET_NAME=" "$PATH_TO_ODOO/.env" | cut -d '=' -f2- | sed 's/^[[:space:]]*//;s/[[:space:]]*$//;s/^["'\'']//;s/["'\'']$//')

  ## This variable below to define the new variable (DON'T EDIT)
  # Use array for files
  files_dirs_to_tar=()

  ## Add Directory (ADD MORE VARIABLE TO ADD NEW DIRECTORY for the archive by uncommenting and adding.)
  # files_dirs_to_tar+=("enter_path_to_directory")

  ## Make sure that the git directory and odoo base directory has git_hashes.txt file.
  ## If not, you need to change this to the directory of odoo modules and odoo-base instead of git_hashes.txt.
  ## enter the correct path
  files_dirs_to_tar+=("git/git_hashes.txt")
  files_dirs_to_tar+=("odoo-base/git_hashes.txt")

  ## Add the additional odoo module directory that don't use git (uncomment and add the path of the directory)
  # files_dirs_to_tar+=("git/enter_additional_git_odoo_module_directory")

  ## Make sure that the datadir location is correct (enter the correct one)
  files_dirs_to_tar+=("/var/lib/odoo/$SERVICE_NAME/filestore/$ODOO_DATABASE_NAME_PRD")

  log_info "Change WORKDIR to $PATH_TO_ODOO."
  if ! cd "$PATH_TO_ODOO"; then
    log_error "Can't change directory to $PATH_TO_ODOO"
    exit 1
  fi

  TAR_FILE_NAME=snapshot-$SERVICE_NAME.tar.zst
  TAR_FILE_PATH=/tmp/$TAR_FILE_NAME

  areYouReallySure "$TAR_FILE_PATH" "$ASK_TO_REPLACE_EXISTING_SNAPSHOT"

  files_dirs_to_tar+=(".secrets/db_user")
  files_dirs_to_tar+=(".secrets/db_password")
  files_dirs_to_tar+=("conf/odoo.conf")
  files_dirs_to_tar+=(".env")
  files_dirs_to_tar+=("requirements.txt")

  # Use secure temp file for SQL dump
  SQL_DUMP_FILE=$(mktemp --tmpdir "${ODOO_DATABASE_NAME_PRD}_XXXXXX.sql")
  chown postgres "$SQL_DUMP_FILE"
  files_dirs_to_tar+=("$SQL_DUMP_FILE")

  # These files not backupped to the snapshot file
  ## crontab or /etc.cron.d directory is the place where docker-odoo cron jobs are stored.
  ## /etc/nginx/sites-available is the place where nginx configuration files are stored.
  ## /etc/logrotate.d is the place where logrotate configuration files are stored.

  if [ -f "scripts/backupdata-$SERVICE_NAME" ]; then
    files_dirs_to_tar+=("scripts/backupdata-$SERVICE_NAME")
  fi

  if [ -f "scripts/databasecloner-$SERVICE_NAME" ]; then
    files_dirs_to_tar+=("scripts/databasecloner-$SERVICE_NAME")
  fi

  if [ -f "scripts/snapshot-$SERVICE_NAME" ]; then
    files_dirs_to_tar+=("scripts/snapshot-$SERVICE_NAME")
  fi

  if ! command -v zstd >/dev/null 2>&1; then
    log_error "zstd is not installed. Please install zstd first."
    echo "For Ubuntu: sudo apt install zstd"
    echo "For CentOS: sudo yum install zstd"
    exit 1
  fi

  writeGitHash "$PATH_TO_ODOO/git"
  writeGitHash "$PATH_TO_ODOO/odoo-base"

  log_info "Dumping $ODOO_DATABASE_NAME_PRD database to $SQL_DUMP_FILE..."
  # Use the secure temp file
  if ! sudo -u postgres pg_dump -f "$SQL_DUMP_FILE" "$ODOO_DATABASE_NAME_PRD" > /dev/null 2>&1; then
    log_error "pg_dump failed to dump the database."
    exit 1
  fi

  log_info "Backing up the database and its datadir..."
  # Use array expansion
  if ! tar -cf "$TAR_FILE_PATH" -I "zstd -vT0 -7 --ultra" "${files_dirs_to_tar[@]}" > /dev/null 2>&1; then
    log_error "tar failed to backup the database and its datadir."
    exit 1
  fi

  log_info "Changing the ownership of the snapshot file..."
  chown "$REPOSITORY_OWNER": "$TAR_FILE_PATH"

  if [ "$GCS_BUCKET_NAME" != "" ]; then
    if sudo -u "$REPOSITORY_OWNER" gsutil ls "gs://$GCS_BUCKET_NAME" > /dev/null 2>&1; then
      log_info "Moving the snapshot file to Google Cloud Storage bucket: gs://$GCS_BUCKET_NAME."
      if sudo -u "$REPOSITORY_OWNER" gsutil -m mv "$TAR_FILE_PATH" "gs://$GCS_BUCKET_NAME/$TAR_FILE_NAME"; then
        log_success "The snapshot File Created Successfully named $TAR_FILE_NAME. File Backed up at gs://$GCS_BUCKET_NAME/$TAR_FILE_NAME."
      else
        log_error "Error can't move the snapshot file to gs://$GCS_BUCKET_NAME. Exit code: $?"
        moveSnapshotFileToTempDir "$TAR_FILE_PATH" "$TAR_FILE_NAME"
      fi
    else
      log_error "Error cannot move the snapshot file to Google Cloud Storage (GCS). Exit code: $?"
      log_error "Please make sure the GCS_BUCKET_NAME on your .env file is the valid GCS Bucket Name."
      moveSnapshotFileToTempDir "$TAR_FILE_PATH" "$TAR_FILE_NAME"
    fi
  else
    moveSnapshotFileToTempDir "$TAR_FILE_PATH" "$TAR_FILE_NAME"
  fi
  echo
}

main "$@"
